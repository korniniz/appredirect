<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Board Meeting Room — Calendar</title>
  <meta name="description" content="Live room bookings from Outlook resource calendar">

  <!-- FullCalendar CSS (global build) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css">

  <style>
    :root { --brand:#0e5fa6; --muted:#6b7280; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 12px; }
    .topbar { display:flex; align-items:center; justify-content:space-between; margin-bottom:10px; }
    .title { font-weight:700; color:#111827; font-size:18px; }
    .meta { color:var(--muted); font-size:12px; }
    #calendar { background:#fff; border:1px solid #e5e7eb; border-radius:12px; overflow:hidden; }
    .notice { display:none; margin-top:10px; color:#b91c1c; font-size:13px; }
    .fc .fc-button-primary { background:var(--brand); border-color:var(--brand); }
    .fc .fc-button-primary:disabled { background:#9ca3af; border-color:#9ca3af; }
  </style>

  <!-- FullCalendar core + plugins (GLOBAL builds) -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.15/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/timegrid@6.1.15/index.global.min.js"></script>

  <!-- ical.js (required by the iCalendar plugin) -->
  <script src="https://unpkg.com/ical.js@1.5.0/build/ical.min.js"></script>

  <!-- FullCalendar iCalendar plugin -->
  <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/icalendar@6.1.15/index.global.min.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="title">Board Meeting Room — Calendar</div>
      <div class="meta" id="updated">Loading…</div>
    </div>

    <div id="calendar"></div>
    <div id="notice" class="notice">⚠️ We couldn’t load the ICS feed. Check the Worker URL or CORS proxy.</div>
  </div>

  <script>
    // Cloudflare Worker that serves the ICS with CORS
    const WORKER_URL = "https://checking-boardmeetr8-nhc.korrakieadkeynkak12955.workers.dev/";

    // If you prefer to pass the Outlook ICS explicitly:
    // const OUTLOOK_ICS = "https://outlook.office365.com/owa/calendar/.../calendar.ics";
    // const EVENTS_URL = WORKER_URL + "?u=" + encodeURIComponent(OUTLOOK_ICS);

    // Using DEFAULT_ICS from the worker:
    const EVENTS_URL = WORKER_URL;

    function fmtUpdated(dt = new Date()) {
      return 'Updated ' + dt.toLocaleString('en-GB', { hour12: false });
    }

    document.addEventListener('DOMContentLoaded', () => {
      const updatedEl = document.getElementById('updated');
      const noticeEl  = document.getElementById('notice');

      const calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
        plugins: [ dayGridPlugin, timeGridPlugin, icalendarPlugin ],
        initialView: 'dayGridMonth',
        height: 'auto',
        expandRows: true,
        timeZone: 'Asia/Bangkok',

        headerToolbar: {
          left: 'prev today next',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },

        buttonText: { today: 'Today', month: 'Month', week: 'Week', day: 'Day' },

        // TimeGrid options (optional, tweak as needed)
        slotMinTime: '07:00:00',
        slotMaxTime: '21:00:00',
        slotDuration: '00:30:00',
        nowIndicator: true,

        eventTimeFormat: { hour: '2-digit', minute: '2-digit', hour12: false },
        eventDisplay: 'block',
        eventContent: (arg) => {
          const time = arg.timeText || '';
          const title = (arg.event.title && arg.event.title.trim()) ? arg.event.title : 'Busy';
          return { html: `<span class="fc-event-time">${time}</span> <span class="fc-event-title">${title}</span>` };
        },

        eventSources: [{
        url: "https://checking-boardmeetr8-nhc.korrakieadkeynkak12955.workers.dev/",
        format: "ics",
        extraParams: () => ({ t: Date.now() }), // cache-bust, avoids conditional requests
        failure: (err) => { /* show notice */ }
        }],

        datesSet: () => calendar.refetchEvents()
      });

      calendar.render();
      updatedEl.textContent = fmtUpdated();

      setInterval(() => {
        calendar.refetchEvents();
        updatedEl.textContent = fmtUpdated();
        noticeEl.style.display = 'none';
      }, 60000);

      document.addEventListener('visibilitychange', () => {
        if (!document.hidden) {
          calendar.refetchEvents();
          updatedEl.textContent = fmtUpdated();
          noticeEl.style.display = 'none';
        }
      });
    });
  </script>
</body>
</html>
